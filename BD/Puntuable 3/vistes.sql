/* VISTES */

CREATE TABLE dept (
 dept_no  TINYINT (2),
 dnom     VARCHAR(14) NOT NULL UNIQUE,
 loc      VARCHAR(14),
 PRIMARY KEY (dept_no) );
CREATE TABLE emp (
 emp_no    SMALLINT (4),
 cognom    VARCHAR (10) NOT NULL,
 ofici     VARCHAR (10),
 cap       SMALLINT (4),
 data_alta DATE,
 salari    INT,
 comissio  INT,
 dept_no   TINYINT (2) NOT NULL,
 PRIMARY KEY (EMP_NO),
 FOREIGN KEY (dept_no) REFERENCES dept(dept_no),
 FOREIGN KEY (cap) REFERENCES emp(emp_no));
sqlite> select * from dept;
/*
10|COMPTABILITAT|SEVILLA
20|INVESTIGACIO|MADRID
30|VENDES|BARCELONA
40|PRODUCCIO|BILBAO
*/
sqlite> select * from emp;
/*
7369|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||20
7499|ARROYO|VENEDOR|7698|1980-02-20|208000|39000|30
7521|SALA|VENEDOR|7698|1981-02-22|162500|65000|30
7566|JIMENEZ|DIRECTOR|7839|1981-04-02|386750||20
7654|MARTIN|VENEDOR|7698|1981-09-29|162500|182000|30
7698|NEGRO|DIRECTOR|7839|1981-05-01|370500||30
7782|CEREZO|DIRECTOR|7839|1981-06-09|318500||10
7788|GIL|ANALISTA|7566|1981-11-09|390000||20
7839|REY|PRESIDENT||1981-11-17|650000||10
7844|TOVAR|VENEDOR|7698|1981-09-08|195000|0|30
7876|ALONSO|EMPLEAT|7788|1981-09-23|143000||20
7900|JIMENO|EMPLEAT|7698|1981-12-03|123500||30
7902|FERNANDEZ|ANALISTA|7566|1981-12-03|390000||20
7934|MUNOZ|EMPLEAT|7782|1982-01-23|169000||10
*/
sqlite> create view dades as select * from emp join dept;
sqlite> select * from dades where loc='BARCELONA';
/*
7369|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||20|30|VENDES|BARCELONA
7499|ARROYO|VENEDOR|7698|1980-02-20|208000|39000|30|30|VENDES|BARCELONA
7521|SALA|VENEDOR|7698|1981-02-22|162500|65000|30|30|VENDES|BARCELONA
7566|JIMENEZ|DIRECTOR|7839|1981-04-02|386750||20|30|VENDES|BARCELONA
7654|MARTIN|VENEDOR|7698|1981-09-29|162500|182000|30|30|VENDES|BARCELONA
7698|NEGRO|DIRECTOR|7839|1981-05-01|370500||30|30|VENDES|BARCELONA
7782|CEREZO|DIRECTOR|7839|1981-06-09|318500||10|30|VENDES|BARCELONA
7788|GIL|ANALISTA|7566|1981-11-09|390000||20|30|VENDES|BARCELONA
7839|REY|PRESIDENT||1981-11-17|650000||10|30|VENDES|BARCELONA
7844|TOVAR|VENEDOR|7698|1981-09-08|195000|0|30|30|VENDES|BARCELONA
7876|ALONSO|EMPLEAT|7788|1981-09-23|143000||20|30|VENDES|BARCELONA
7900|JIMENO|EMPLEAT|7698|1981-12-03|123500||30|30|VENDES|BARCELONA
7902|FERNANDEZ|ANALISTA|7566|1981-12-03|390000||20|30|VENDES|BARCELONA
7934|MUNOZ|EMPLEAT|7782|1982-01-23|169000||10|30|VENDES|BARCELONA
*/
sqlite> INSERT INTO emp VALUES (999,'SANCHEZ','EMPLEAT',7902, '1980-12-17', 104000,NULL,0);
sqlite> INSERT INTO emp VALUES (9999,'SANCHEZ','EMPLEAT',7902, '1980-12-17', 104000,NULL,30);

/* Actualitzacio automatica */
sqlite> select * from dades where loc='BARCELONA';
/*
7369|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||20|30|VENDES|BARCELONA
7499|ARROYO|VENEDOR|7698|1980-02-20|208000|39000|30|30|VENDES|BARCELONA
7521|SALA|VENEDOR|7698|1981-02-22|162500|65000|30|30|VENDES|BARCELONA
7566|JIMENEZ|DIRECTOR|7839|1981-04-02|386750||20|30|VENDES|BARCELONA
7654|MARTIN|VENEDOR|7698|1981-09-29|162500|182000|30|30|VENDES|BARCELONA
7698|NEGRO|DIRECTOR|7839|1981-05-01|370500||30|30|VENDES|BARCELONA
7782|CEREZO|DIRECTOR|7839|1981-06-09|318500||10|30|VENDES|BARCELONA
7788|GIL|ANALISTA|7566|1981-11-09|390000||20|30|VENDES|BARCELONA
7839|REY|PRESIDENT||1981-11-17|650000||10|30|VENDES|BARCELONA
7844|TOVAR|VENEDOR|7698|1981-09-08|195000|0|30|30|VENDES|BARCELONA
7876|ALONSO|EMPLEAT|7788|1981-09-23|143000||20|30|VENDES|BARCELONA
7900|JIMENO|EMPLEAT|7698|1981-12-03|123500||30|30|VENDES|BARCELONA
7902|FERNANDEZ|ANALISTA|7566|1981-12-03|390000||20|30|VENDES|BARCELONA
7934|MUNOZ|EMPLEAT|7782|1982-01-23|169000||10|30|VENDES|BARCELONA
999|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||0|30|VENDES|BARCELONA
9999|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||30|30|VENDES|BARCELONA
*/


/* Si inserim dades en la vista, s'actualitzen les taules associades ?? */

sqlite> INSERT INTO dades VALUES (9999,'SANCHEZ','EMPLEAT',7902, '1980-12-17', 104000,NULL,30,'VENDES','BARCELONA');
/*
Error: cannot modify dades because it is a view
*/

/* Fer una vista modificable a traves de l'Us de triggers instead of */
sqlite> create trigger view_dades2 instead of update on dades
   ...> begin
   ...> update dept set dnom=new.dnom where dept_no=new.dept_no;
   ...> end;

update dades set dnom='VENDES_A' where dept_no=30;
/*
sqlite> select * from dept;
10|COMPTABILITAT|SEVILLA
20|INVESTIGACIO|MADRID
30|VENDES_A|BARCELONA
40|PRODUCCIO|BILBAO

sqlite> select * from dades where loc='BARCELONA';
7369|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||20|30|VENDES_A|BARCELONA
7499|ARROYO|VENEDOR|7698|1980-02-20|208000|39000|30|30|VENDES_A|BARCELONA
7521|SALA|VENEDOR|7698|1981-02-22|162500|65000|30|30|VENDES_A|BARCELONA
7566|JIMENEZ|DIRECTOR|7839|1981-04-02|386750||20|30|VENDES_A|BARCELONA
7654|MARTIN|VENEDOR|7698|1981-09-29|162500|182000|30|30|VENDES_A|BARCELONA
7698|NEGRO|DIRECTOR|7839|1981-05-01|370500||30|30|VENDES_A|BARCELONA
7782|CEREZO|DIRECTOR|7839|1981-06-09|318500||10|30|VENDES_A|BARCELONA
7788|GIL|ANALISTA|7566|1981-11-09|390000||20|30|VENDES_A|BARCELONA
7839|REY|PRESIDENT||1981-11-17|650000||10|30|VENDES_A|BARCELONA
7844|TOVAR|VENEDOR|7698|1981-09-08|195000|0|30|30|VENDES_A|BARCELONA
7876|ALONSO|EMPLEAT|7788|1981-09-23|143000||20|30|VENDES_A|BARCELONA
7900|JIMENO|EMPLEAT|7698|1981-12-03|123500||30|30|VENDES_A|BARCELONA
7902|FERNANDEZ|ANALISTA|7566|1981-12-03|390000||20|30|VENDES_A|BARCELONA
7934|MUNOZ|EMPLEAT|7782|1982-01-23|169000||10|30|VENDES_A|BARCELONA
999|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||0|30|VENDES_A|BARCELONA
9999|SANCHEZ|EMPLEAT|7902|1980-12-17|104000||30|30|VENDES_A|BARCELONA
*/

/* Proveu !!!
CREATE TRIGGER view_delete_trig 
INSTEAD OF delete

CREATE TRIGGER view_delete_trig 
INSTEAD OF insert
*/

/* Vistes de vistes */
create view dades2 as select * from dades where loc='BARCELONA';

/* Eliminar vistes */
/*drop view*/
